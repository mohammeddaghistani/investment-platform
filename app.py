import streamlit as st
import pandas as pd
import numpy as np
import qrcode
from io import BytesIO
from datetime import datetime
import plotly.express as px
import streamlit_authenticator as stauth

# ==========================================
# 1. ูุธุงู ุงูุญูุงูุฉ (Login System) - ุงููุณุฎุฉ ุงููุณุชูุฑุฉ
# ==========================================
credentials = {
    "usernames": {
        "invest_admin": {
            "name": "ุฅุฏุงุฑุฉ ุงูุงุณุชุซูุงุฑ ุงูุงุณุชุฑุงุชูุฌู",
            "password": "$2b$12$EixZaYVK1Vz17Uy5vQPfbOfh17S2REAlX.y7n6tE9R.o5B1oH7EWG" # admin123
        }
    }
}

authenticator = stauth.Authenticate(credentials, "invest_vault", "key_2026", 1)

# ูุงุฌูุฉ ุชุณุฌูู ุงูุฏุฎูู
try:
    auth_result = authenticator.login(location='main')
except Exception:
    pass

if st.session_state.get("authentication_status") is not True:
    st.warning("๐ ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูููุตูู ุฅูู ุงูููุตุฉ ุงููุงููุฉ")
else:
    # --- ุจุฏุงูุฉ ุงููุญุชูู ุงููุงูู ูุงูุดุงูู ---
    
    with st.sidebar:
        st.success(f"ูุฑุญุจุงู ุจู: {st.session_state['name']}")
        authenticator.logout('ุชุณุฌูู ุงูุฎุฑูุฌ', 'sidebar')
        st.divider()
        st.header("๐๏ธ ูุนุงููุงุช ุงููุญุต (Due Diligence)")
        loc_zone = st.selectbox("ุงููุทุงู ุงูุฌุบุฑุงูู", ["ุงูููุทูุฉ ุงููุฑูุฒูุฉ", "ูุญูุฑ ุฑุฆูุณู", "ุฏุงุฎู ุงูุฃุญูุงุก", "ุฃุทุฑุงู ุงููุฏููุฉ"])
        site_access = st.slider("ุณูููุฉ ุงููุตูู ูููููุน (%)", 0, 100, 80)
        tech_risks = st.slider("ูุนุงูู ุงููุฎุงุทุฑ ุงููููุฉ (%)", 0, 100, 10)
        
    # ==========================================
    # 2. ูุงุนุฏุฉ ุจูุงูุงุช ุงูู 17 ูุดุงุทุงู (Full Database)
    # ==========================================
    ACTIVITIES_DB = {
        "ุงูุชุฌุงุฑูุฉ": {"max_term": 50, "method": "ุงููุชุจูู", "suit": ["ูุฑูุฒ ุงููุฏููุฉ", "ูุญูุฑ ุฑุฆูุณู"]},
        "ุงูุตูุงุนูุฉ": {"max_term": 25, "method": "ุงูุณูู", "suit": ["ููุทูุฉ ุตูุงุนูุฉ"]},
        "ุงูุณูุงุญูุฉ": {"max_term": 50, "method": "ุงููุชุจูู", "suit": ["ูุงุฌูุฉ ุจุญุฑูุฉ"]},
        "ุงูุตุญูุฉ": {"max_term": 25, "method": "ุงูุฏุฎู", "suit": ["ุญู ุณููู"]},
        "ุงูุชุนููููุฉ": {"max_term": 25, "method": "ุงูุฏุฎู", "suit": ["ุญู ุณููู"]},
        "ุงูุฑูุงุถูุฉ ูุงูุชุฑููููุฉ": {"max_term": 30, "method": "ุงูุฏุฎู", "suit": ["ูุญูุฑ ุฑุฆูุณู"]},
        "ุงูุฒุฑุงุนูุฉ ูุงูุญููุงููุฉ": {"max_term": 20, "method": "ุงูุณูู", "suit": ["ููุทูุฉ ุทุฑููุฉ"]},
        "ุงูุงุฌุชูุงุนูุฉ": {"max_term": 25, "method": "ุงูุชูููุฉ", "suit": ["ุญู ุณููู"]},
        "ุงูููู": {"max_term": 20, "method": "ุงูุณูู", "suit": ["ูุญูุฑ ุฑุฆูุณู"]},
        "ุงููุงููุฉ": {"max_term": 15, "method": "ุงูุณูู", "suit": ["ูุฑูุฒ ุงููุฏููุฉ"]},
        "ุงูุงุชุตุงูุงุช": {"max_term": 15, "method": "ุงูุณูู", "suit": ["ูุญูุฑ ุฑุฆูุณู"]},
        "ุงูุฎุฏูุงุช ุงูุนุงูุฉ": {"max_term": 25, "method": "ุงูุชูููุฉ", "suit": ["ุญู ุณููู"]},
        "ุงููุฑูุจุงุช": {"max_term": 15, "method": "ุงูุณูู", "suit": ["ููุทูุฉ ุตูุงุนูุฉ"]},
        "ุงูุตูุงูุฉ ูุงูุชุฑููุจ": {"max_term": 10, "method": "ุงูุณูู", "suit": ["ููุทูุฉ ุตูุงุนูุฉ"]},
        "ุงูุชุดููุฏ ูุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช": {"max_term": 20, "method": "ุงูุฏุฎู", "suit": ["ูุญูุฑ ุฑุฆูุณู"]},
        "ุงูููุจูุณุงุช ูุงูููุณูุฌุงุช": {"max_term": 10, "method": "ุงูุณูู", "suit": ["ูุฑูุฒ ุงููุฏููุฉ"]},
        "ุงููุฑุงูู ุงูุนุงูุฉ": {"max_term": 50, "method": "ุงูุชูููุฉ", "suit": ["ูุญูุฑ ุฑุฆูุณู"]}
    }

    st.title("๐๏ธ ููุตุฉ ุฅุณุชุฏุงูุฉ | ุงููุณุฎุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงููุชูุงููุฉ")
    tabs = st.tabs(["๐ ุฑุงุฏุงุฑ ุงูููุงุกูุฉ", "๐ฐ ุงูุชูููู ุงููุงูู ุงููุนูู", "๐ ุชุญููู ุงูู 1800 ุนูุฏ", "๐ ุงูุชูุงุฑูุฑ ูุงูููุซูููุฉ"])

    # --- ุงูุชุจููุจ 1: ุฑุงุฏุงุฑ ุงูููุงุกูุฉ ูุงูุฏูููุบุฑุงููุง ---
    with tabs[0]:
        c1, c2 = st.columns(2)
        selected_act = c1.selectbox("ุงููุดุงุท ุงููุณุชูุฏู", list(ACTIVITIES_DB.keys()))
        suit_score = min(50 + (site_access * 0.4) - (tech_risks * 0.2), 100)
        c1.metric("ุฏุฑุฌุฉ ุงูููุงุกูุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ", f"{int(suit_score)}/100")
        c1.progress(suit_score / 100)
        
        pop = c2.number_input("ุงูุณูุงู ุงูุญุงูููู (ูุทุงู 5 ูู)", value=50000)
        growth = c2.slider("ูุนุฏู ุงูููู ุงูุณููู (%)", 0.0, 5.0, 2.5) / 100
        future_pop = pop * ((1 + growth) ** 10)
        c2.info(f"๐ ุงูุณูุงู ุงููุชููุน (ุนุงู 2036): {int(future_pop):,} ูุณูุฉ")
        

    # --- ุงูุชุจููุจ 2: ุงูุชูููู ุงููุงูู (ุงููุงุฏุฉ 26 + ูุชุฑุฉ ุงูุณูุงุญ) ---
    with tabs[1]:
        col_in, col_res = st.columns(2)
        with col_in:
            gdv = st.number_input("ุงููููุฉ ุงูุชุทููุฑูุฉ (GDV)", value=40000000)
            capex = st.number_input("ุชูููุฉ ุงููุดุฑูุน (CAPEX)", value=25000000)
            term = st.slider("ูุฏุฉ ุงูุนูุฏ", 5, ACTIVITIES_DB[selected_act]["max_term"], 25)
            grace = int(term * 0.10) # ุงููุงุฏุฉ 20: 10% ูุชุฑุฉ ุณูุงุญ
            st.write(f"โฑ๏ธ ูุชุฑุฉ ุงูุณูุงุญ ุงููุธุงููุฉ: **{grace} ุณููุงุช**")
            
        with col_res:
            zone_multiplier = {"ุงูููุทูุฉ ุงููุฑูุฒูุฉ": 1.4, "ูุญูุฑ ุฑุฆูุณู": 1.2, "ุฏุงุฎู ุงูุฃุญูุงุก": 1.0, "ุฃุทุฑุงู ุงููุฏููุฉ": 0.7}
            base_rent = max((gdv - capex * 1.15) * 0.08, gdv * 0.04) * zone_multiplier[loc_zone]
            st.metric("ุงูุฃุฌุฑุฉ ุงูุณูููุฉ ุงูุนุงุฏูุฉ (ุงูุณูุฉ ุงูุฃููู)", f"{base_rent:,.0f} ุฑูุงู")
            
            # ูุตูููุฉ ุงูููู (ุงููุงุฏุฉ 26: ุฒูุงุฏุฉ 5% ูู 5 ุณููุงุช)
            schedule = [0]*grace + [base_rent * (1.05 ** (i // 5)) for i in range(term - grace)]
            st.area_chart(schedule)
            

    # --- ุงูุชุจููุจ 3: ููุญุฉ ุงูุชุญูู (ุชุญููู ุงูู 1800 ุนูุฏ) ---
    with tabs[2]:
        st.subheader("๐ ุชุญููู ูุฌูุฉ ุงูุฅูุฑุงุฏุงุช ูู ุงููุญูุธุฉ ุงูุนูุงุฑูุฉ")
        kpi_data = pd.DataFrame({
            'ุงููุดุงุท': ['ุชุฌุงุฑู', 'ุณูุงุญู', 'ุตุญู', 'ุชุนูููู', 'ุตูุงุนู'],
            'ุงูุฅูุฑุงุฏ ุงูุญุงูู': [120, 80, 45, 30, 65],
            'ุงูุฅูุฑุงุฏ ุงูุนุงุฏู ุงููุณุชูุฏู': [155, 110, 55, 42, 85]
        })
        fig = px.bar(kpi_data, x='ุงููุดุงุท', y=['ุงูุฅูุฑุงุฏ ุงูุญุงูู', 'ุงูุฅูุฑุงุฏ ุงูุนุงุฏู ุงููุณุชูุฏู'], 
                     barmode='group', title="ุงูุฃุฑุจุงุญ ุงููุณุชุฑุฏุฉ ุจุงูููููู ุฑูุงู",
                     color_discrete_sequence=['#1e3d59', '#d35400'])
        st.plotly_chart(fig, use_container_width=True)
        

    # --- ุงูุชุจููุจ 4: ุงูุชูุงุฑูุฑ ูุงูู QR ---
    with tabs[3]:
        st.subheader("๐ ุฅุตุฏุงุฑ ุชูุฑูุฑ ุงูุชูููู ุงููุนุชูุฏ")
        contract_id = st.text_input("ุฑูู ุงูุนูุฏ", "30040868948")
        report_text = f"ุชูุฑูุฑ ุชูููู ูุดุงุท {selected_act}\nุงูุนูุฏ: {contract_id}\nุงูุฃุฌุฑุฉ: {base_rent:,.0f} ุฑูุงู\nูุชุฑุฉ ุงูุณูุงุญ: {grace} ุณููุงุช"
        st.code(report_text)
        
        qr_data = f"ID:{contract_id}|Rent:{base_rent:.0f}|By:{st.session_state['name']}"
        qr = qrcode.make(qr_data)
        buf = BytesIO()
        qr.save(buf, format="PNG")
        st.image(buf.getvalue(), caption="ุฎุชู ุงูููุซูููุฉ ุงูุฑููู")

st.markdown("---")
st.caption("ููุตุฉ ุฅุณุชุฏุงูุฉ | ุงููุณุฎุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุดุงููุฉ - ููุฉ ุงูููุฑูุฉ 2026")
