import streamlit as st
import pandas as pd
import numpy as np
import qrcode
from io import BytesIO
import plotly.express as px
import streamlit_authenticator as stauth

# ==========================================
# 1. ูุธุงู ุงูุญูุงูุฉ ูุงูุฃูุงู (Login & Security)
# ==========================================
credentials = {
    "usernames": {
        "invest_admin": {
            "name": "ุฅุฏุงุฑุฉ ุงูุงุณุชุซูุงุฑ ุงูุงุณุชุฑุงุชูุฌู",
            "password": "$2b$12$EixZaYVK1Vz17Uy5vQPfbOfh17S2REAlX.y7n6tE9R.o5B1oH7EWG" # admin123
        }
    }
}
authenticator = stauth.Authenticate(credentials, "invest_vault", "key_2026", 1)

try:
    auth_result = authenticator.login(location='main')
except Exception:
    pass

if st.session_state.get("authentication_status") is not True:
    st.warning("๐ ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูููุตูู ุฅูู ุงููุธุงู ุงููุชูุงูู")
else:
    # --- ุจุฏุงูุฉ ุงููุญุชูู ุงููุงูู (ุจุฏูู ุฃู ููุต) ---
    
    with st.sidebar:
        st.success(f"ูุฑุญุจุงู ุจู: {st.session_state['name']}")
        authenticator.logout('ุชุณุฌูู ุงูุฎุฑูุฌ', 'sidebar')
        st.divider()
        st.header("โ๏ธ ูุนุงููุงุช ุงููุญุต (Due Diligence)")
        loc_zone = st.selectbox("ูุทุงู ุงููููุน ุงูุฌุบุฑุงูู", ["ุงูููุทูุฉ ุงููุฑูุฒูุฉ", "ูุญูุฑ ุฑุฆูุณู (A)", "ุฏุงุฎู ุงูุฃุญูุงุก (B)", "ุฃุทุฑุงู ุงููุฏููุฉ"])
        land_area = st.number_input("ูุณุงุญุฉ ุงูุฃุฑุถ (ู2)", value=1000)
        tech_risks = st.slider("ูุนุงูู ุงููุฎุงุทุฑ ุงููููุฉ (%)", 0, 100, 10)

    # ==========================================
    # 2. ูุญุฑู ุงูุฃูุดุทุฉ ุงูู 17 ูุถูุงุจุท ุงููุงุฆุญุฉ
    # ==========================================
    ACTIVITIES_DB = {
        "ุงูุชุฌุงุฑูุฉ": {"max_term": 50, "method": "ุงููุชุจูู", "grace_rate": 0.10},
        "ุงูุณูุงุญูุฉ": {"max_term": 50, "method": "ุงููุชุจูู", "grace_rate": 0.10},
        "ุงูุตุญูุฉ": {"max_term": 25, "method": "ุงูุฏุฎู", "grace_rate": 0.10},
        "ุงูุชุนููููุฉ": {"max_term": 25, "method": "ุงูุฏุฎู", "grace_rate": 0.10},
        "ุงูุตูุงุนูุฉ": {"max_term": 25, "method": "ุงูุณูู", "grace_rate": 0.10},
        "ุงูุฑูุงุถูุฉ ูุงูุชุฑููููุฉ": {"max_term": 30, "method": "ุงูุฏุฎู", "grace_rate": 0.10},
        "ุงูุงุฌุชูุงุนูุฉ": {"max_term": 25, "method": "ุงูุชูููุฉ", "grace_rate": 0.10},
        "ุงูุฒุฑุงุนูุฉ": {"max_term": 20, "method": "ุงูุณูู", "grace_rate": 0.05},
        "ุงูููู": {"max_term": 20, "method": "ุงูุณูู", "grace_rate": 0.05},
        "ุงููุงููุฉ": {"max_term": 15, "method": "ุงูุณูู", "grace_rate": 0.05},
        "ุงูุงุชุตุงูุงุช": {"max_term": 15, "method": "ุงูุณูู", "grace_rate": 0.05},
        "ุงููุฑูุจุงุช": {"max_term": 15, "method": "ุงูุณูู", "grace_rate": 0.05},
        "ุงูุฎุฏูุงุช ุงูุนุงูุฉ": {"max_term": 25, "method": "ุงูุชูููุฉ", "grace_rate": 0.10},
        "ุงููุฑุงูู ุงูุนุงูุฉ": {"max_term": 50, "method": "ุงูุชูููุฉ", "grace_rate": 0.10},
        "ุงูุชุดููุฏ ูุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช": {"max_term": 20, "method": "ุงูุฏุฎู", "grace_rate": 0.05},
        "ุงูุตูุงูุฉ ูุงูุชุฑููุจ": {"max_term": 10, "method": "ุงูุณูู", "grace_rate": 0.05},
        "ุงูููุจูุณุงุช ูุงูููุณูุฌุงุช": {"max_term": 10, "method": "ุงูุณูู", "grace_rate": 0.05}
    }

    st.title("๐๏ธ ููุตุฉ ุฅุณุชุฏุงูุฉ | ููุธููุฉ ุงูุงุณุชุซูุงุฑ ูุงูุชูููู ุงูุนูุงุฑู")
    tabs = st.tabs(["๐ ุงูููุงุกูุฉ ูุงูุฏูููุบุฑุงููุง", "๐ฐ ุงูุชูููู (ุงููุงุฏุฉ 26)", "๐ ุชุญููู ุงูู 1800 ุนูุฏ", "๐ ุงูุชูุงุฑูุฑ ูุงูุชุญูู"])

    # --- ุงูุชุจููุจ 1: ุฑุงุฏุงุฑ ุงูููุงุกูุฉ ูุงูููู ุงูุณูุงูู ---
    with tabs[0]:
        c1, c2 = st.columns(2)
        selected_act = c1.selectbox("ุงุฎุชุฑ ุงููุดุงุท ุงูุงุณุชุซูุงุฑู", list(ACTIVITIES_DB.keys()))
        
        # ูุญุฑู ุงูููุงุกูุฉ (ุจูุงุกู ุนูู ุงููููุน ูุงููุดุงุท)
        suit_score = 100 - tech_risks
        c1.metric("ุฏุฑุฌุฉ ููุงุกูุฉ ุงููููุน", f"{suit_score}/100")
        c1.progress(suit_score / 100)
        
        pop = c2.number_input("ุงูุณูุงู ุงูุญุงูููู (ูุทุงู 5 ูู)", value=50000)
        growth = c2.slider("ูุนุฏู ุงูููู ุงูุณููู (%)", 0.0, 5.0, 2.7) / 100
        future_pop = pop * ((1 + growth) ** 10)
        c2.info(f"๐ ุงูุณูุงู ุงููุชููุน ูุนุงู 2036: {int(future_pop):,} ูุณูุฉ")
        

    # --- ุงูุชุจููุจ 2: ูุญุฑู ุงูุชูููู ุงููุงูู ุงููุนูู (Core Engine) ---
    with tabs[1]:
        col_in, col_res = st.columns(2)
        with col_in:
            gdv = st.number_input("ุงููููุฉ ุงูุชุทููุฑูุฉ (GDV) / ู2", value=5000)
            total_gdv = gdv * land_area
            capex = st.number_input("ุชูููุฉ ุงูุจูุงุก (CAPEX) / ู2", value=3000)
            total_capex = capex * land_area
            
            term = st.slider("ูุฏุฉ ุงูุนูุฏ (ุณูุฉ)", 5, ACTIVITIES_DB[selected_act]["max_term"], 25)
            # ุงููุงุฏุฉ 20: ุงุญุชุณุงุจ ูุชุฑุฉ ุงูุณูุงุญ ุขููุงู ุจูุงุกู ุนูู ููุน ุงููุดุงุท
            grace = int(term * ACTIVITIES_DB[selected_act]["grace_rate"])
            st.write(f"โฑ๏ธ ูุชุฑุฉ ุงูุณูุงุญ ุงููุธุงููุฉ: **{grace} ุณููุงุช**")
            
        with col_res:
            # ูุญุฑู ุงููููุฉ ุงููุชุจููุฉ (Residual Method)
            zone_mult = {"ุงูููุทูุฉ ุงููุฑูุฒูุฉ": 1.5, "ูุญูุฑ ุฑุฆูุณู (A)": 1.3, "ุฏุงุฎู ุงูุฃุญูุงุก (B)": 1.0, "ุฃุทุฑุงู ุงููุฏููุฉ": 0.8}
            # ูุนุงุฏูุฉ ุงูุฏููู: ุงููููุฉ ุงููุชุจููุฉ = (ุงููููุฉ ุงูุชุทููุฑูุฉ - ุงูุชูุงููู - ุงูุฃุฑุจุงุญ) * ูุนุงูู ุงููููุน
            residual_value = (total_gdv - (total_capex * 1.15)) * zone_mult[loc_zone]
            base_rent = max(residual_value * 0.08, total_gdv * 0.03)
            
            st.metric("ุงูุฃุฌุฑุฉ ุงูุณูููุฉ ุงูุนุงุฏูุฉ", f"{base_rent:,.0f} ุฑูุงู")
            
            # ุฌุฏูู ุงูููู ุงูุฎูุงุณู (ุงููุงุฏุฉ 26: 5% ูู 5 ุณููุงุช)
            schedule = [0]*grace + [base_rent * (1.05 ** (i // 5)) for i in range(term - grace)]
            st.area_chart(schedule, color="#1e3d59")
            st.caption("ุงูุฑุณู ููุถุญ ูุชุฑุฉ ุงูุณูุงุญ ุซู ุงูููุฒุงุช ุงูุฅูุฌุงุฑูุฉ ุงููุธุงููุฉ")
            

    # --- ุงูุชุจููุจ 3: ููุญุฉ ุงูุชุญูู ูุชุญููู ุงููุญูุธุฉ (ุงูู 1800 ุนูุฏ) ---
    with tabs[2]:
        st.subheader("๐ ุชุญููู ูุฌูุฉ ุงููููุฉ ูู ุงููุญูุธุฉ ุงูุนูุงุฑูุฉ")
        # ุจูุงูุงุช ุชุญุงูู ูุงูุน ุงูู 1800 ุนูุฏ (ุงููุฌูุฉ ุจูู ุงูุญุงูู ูุงูุนุงุฏู)
        kpi_data = pd.DataFrame({
            'ุงููุทุงุน': ['ุชุฌุงุฑู', 'ุณูุงุญู', 'ุตุญู', 'ุชุนูููู', 'ุตูุงุนู'],
            'ุงูุฅูุฑุงุฏ ุงูุญุงูู (M)': [120, 80, 45, 30, 65],
            'ุงูุฅูุฑุงุฏ ุงูุนุงุฏู (M)': [155, 110, 58, 42, 85]
        })
        kpi_data['ุงููุฌูุฉ ุงููุณุชุฑุฏุฉ'] = kpi_data['ุงูุฅูุฑุงุฏ ุงูุนุงุฏู (M)'] - kpi_data['ุงูุฅูุฑุงุฏ ุงูุญุงูู (M)']
        
        fig = px.bar(kpi_data, x='ุงููุทุงุน', y=['ุงูุฅูุฑุงุฏ ุงูุญุงูู (M)', 'ุงููุฌูุฉ ุงููุณุชุฑุฏุฉ'], 
                     barmode='stack', title="ูุฑุต ุงุณุชุฑุฏุงุฏ ุงูุฃุฑุจุงุญ ุงูุณูููุฉ",
                     color_discrete_sequence=['#1e3d59', '#d35400'])
        st.plotly_chart(fig, use_container_width=True)
        st.success(f"๐ ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช ุงูุฅุถุงููุฉ ุงูููููุฉ: {kpi_data['ุงููุฌูุฉ ุงููุณุชุฑุฏุฉ'].sum()} ููููู ุฑูุงู ุณูููุงู")
        

    # --- ุงูุชุจููุจ 4: ุงููุฎุฑุฌุงุช ุงููุนุชูุฏุฉ ู QR ---
    with tabs[3]:
        st.subheader("๐ ุฅุตุฏุงุฑ ุชูุฑูุฑ ุงูุชูููู ุงููุนุชูุฏ")
        contract_id = st.text_input("ุฑูู ุงูุนูุฏ ุงููุณุชูุฏู", "30040868948")
        
        report_content = f"""
        ุฅุดุนุงุฑ ุชูููู ุงุณุชุซูุงุฑู - ููุตุฉ ุฅุณุชุฏุงูุฉ
        -----------------------------------
        ุฑูู ุงูุนูุฏ: {contract_id}
        ุงููุดุงุท: {selected_act}
        ูุณุงุญุฉ ุงููููุน: {land_area} ู2
        ุงูุฃุฌุฑุฉ ุงูุณูููุฉ ุงููุนุชูุฏุฉ: {base_rent:,.0f} ุฑูุงู
        ูุชุฑุฉ ุงูุณูุงุญ: {grace} ุณููุงุช
        ุงูุฒูุงุฏุฉ ุงูุฏูุฑูุฉ: 5% ูู 5 ุณููุงุช (ุงููุงุฏุฉ 26)
        -----------------------------------
        ุชู ูุฐุง ุงูุชูููู ุจูุงุกู ุนูู ุฏููู ุณูุงุณุงุช ุงูุชูููู 2023 ููุงุฆุญุฉ ุงูุชุตุฑู ุจุงูุนูุงุฑุงุช ุงูุจูุฏูุฉ.
        """
        st.code(report_content)
        
        qr_str = f"ID:{contract_id}|Rent:{base_rent:.0f}|Zone:{loc_zone}"
        qr = qrcode.make(qr_str)
        buf = BytesIO()
        qr.save(buf, format="PNG")
        st.image(buf.getvalue(), caption="ุฎุชู ุงูููุซูููุฉ ุงูุฑููู ููุชูููู")

st.markdown("---")
st.caption("ููุตุฉ ุฅุณุชุฏุงูุฉ | ุงููุณุฎุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงููุงููุฉ - ููุฉ ุงูููุฑูุฉ 2026")
