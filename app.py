import streamlit as st
import pandas as pd
import numpy as np
import qrcode
from io import BytesIO
import plotly.express as px
import streamlit_authenticator as stauth

# ==========================================
# 1. ูุธุงู ุงูุญูุงูุฉ (ูุชูุงูู ูุน v0.3.2)
# ==========================================
credentials = {
    "usernames": {
        "invest_admin": {
            "name": "ุฅุฏุงุฑุฉ ุงูุงุณุชุซูุงุฑ",
            "password": "$2b$12$EixZaYVK1Vz17Uy5vQPfbOfh17S2REAlX.y7n6tE9R.o5B1oH7EWG" # admin123
        }
    }
}

authenticator = stauth.Authenticate(credentials, "invest_cookie", "key_2026", 1)

# ูุงุฌูุฉ ุชุณุฌูู ุงูุฏุฎูู
try:
    auth_result = authenticator.login(location='main')
except Exception:
    pass

if st.session_state.get("authentication_status") is not True:
    st.warning("๐ ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูููุตูู ุฅูู ุงูููุตุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ")
    if st.session_state.get("authentication_status") is False:
        st.error("ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ")
else:
    # --- ุจุฏุงูุฉ ุงููุญุชูู ุงููุงูู ุจุนุฏ ุงูุฏุฎูู ---
    
    with st.sidebar:
        st.success(f"ูุฑุญุจุงู: {st.session_state['name']}")
        authenticator.logout('ุชุณุฌูู ุงูุฎุฑูุฌ', 'sidebar')
        st.divider()
        st.header("๐ ุฅุนุฏุงุฏุงุช ุงููุทุงู ุงูุฌุบุฑุงูู")
        loc_type = st.selectbox("ุทุจูุนุฉ ุงููููุน", ["ูุฑูุฒ ุงููุฏููุฉ", "ูุญูุฑ ุฑุฆูุณู", "ุญู ุณููู", "ููุทูุฉ ุตูุงุนูุฉ", "ูุงุฌูุฉ ุจุญุฑูุฉ"])
        demand_env = st.select_slider("ุจูุฆุฉ ุงูุทูุจ", options=["ุงูุฎูุงุถ", "ูุณุชูุฑ", "ููู ููู"], value="ูุณุชูุฑ")

    # ==========================================
    # 2. ูุงุนุฏุฉ ุจูุงูุงุช ุงูุฃูุดุทุฉ ูุงูุถูุงุจุท (ุงูู 17 ูุดุงุทุงู)
    # ==========================================
    ACTIVITIES_DB = {
        "ุงูุชุฌุงุฑูุฉ": {"max_term": 50, "method": "ุงููุชุจูู", "grace": 0.10, "suit": ["ูุฑูุฒ ุงููุฏููุฉ", "ูุญูุฑ ุฑุฆูุณู"]},
        "ุงูุตูุงุนูุฉ": {"max_term": 25, "method": "ุงูุณูู", "grace": 0.10, "suit": ["ููุทูุฉ ุตูุงุนูุฉ"]},
        "ุงูุณูุงุญูุฉ": {"max_term": 50, "method": "ุงููุชุจูู", "grace": 0.10, "suit": ["ูุงุฌูุฉ ุจุญุฑูุฉ", "ูุฑูุฒ ุงููุฏููุฉ"]},
        "ุงูุตุญูุฉ": {"max_term": 25, "method": "ุงูุฏุฎู", "grace": 0.10, "suit": ["ุญู ุณููู"]},
        "ุงูุชุนููููุฉ": {"max_term": 25, "method": "ุงูุฏุฎู", "grace": 0.10, "suit": ["ุญู ุณููู"]},
        "ุงูุฑูุงุถูุฉ": {"max_term": 30, "method": "ุงูุฏุฎู", "grace": 0.10, "suit": ["ูุญูุฑ ุฑุฆูุณู"]},
        "ุงูุฒุฑุงุนูุฉ": {"max_term": 20, "method": "ุงูุณูู", "grace": 0.05, "suit": ["ููุทูุฉ ุทุฑููุฉ"]},
        "ุงูุงุฌุชูุงุนูุฉ": {"max_term": 25, "method": "ุงูุชูููุฉ", "grace": 0.10, "suit": ["ุญู ุณููู"]},
        "ุงูููู": {"max_term": 20, "method": "ุงูุณูู", "grace": 0.05, "suit": ["ูุญูุฑ ุฑุฆูุณู"]},
        "ุงููุงููุฉ": {"max_term": 15, "method": "ุงูุณูู", "grace": 0.05, "suit": ["ูุฑูุฒ ุงููุฏููุฉ"]},
        "ุงููุฑูุจุงุช": {"max_term": 15, "method": "ุงูุณูู", "grace": 0.05, "suit": ["ููุทูุฉ ุตูุงุนูุฉ"]},
        "ุงูุฎุฏูุงุช ุงูุนุงูุฉ": {"max_term": 25, "method": "ุงูุชูููุฉ", "grace": 0.10, "suit": ["ุญู ุณููู"]},
        # ูููู ุฅุถุงูุฉ ุจููุฉ ุงูู 17 ููุง ุจููุณ ุงูููุท
    }

    st.title("๐๏ธ ููุตุฉ ุฅุณุชุฏุงูุฉ ุงูุดุงููุฉ ููุงุณุชุซูุงุฑ ูุงูุชูููู")
    tabs = st.tabs(["๐ ุฑุงุฏุงุฑ ุงูููุงุกูุฉ", "๐ฐ ุงูุชูููู ุงููุงูู (ููู ุงูุฏููู)", "๐ ููุญุฉ ุงูุชุญูู (KPIs)", "๐ ุงููุฎุฑุฌุงุช ุงููุธุงููุฉ"])

    # --- ุงูุชุจููุจ 1: ุฑุงุฏุงุฑ ุงูููุงุกูุฉ ูุงูุฏูููุบุฑุงููุง ---
    with tabs[0]:
        col1, col2 = st.columns(2)
        selected_act = col1.selectbox("ุงุฎุชุฑ ุงููุดุงุท ููุชุญููู", list(ACTIVITIES_DB.keys()))
        
        # ูุญุฑู ุงูููุงุกูุฉ
        score = 50
        if loc_type in ACTIVITIES_DB[selected_act]["suit"]: score += 35
        if demand_env == "ููู ููู": score += 15
        
        col1.metric("ุฏุฑุฌุฉ ุงูููุงุกูุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ", f"{score}/100")
        col1.progress(score / 100)
        
        # ุงููุญุฑู ุงูุฏูููุบุฑุงูู
        pop = col2.number_input("ุงูุณูุงู ุงูุญุงูููู ูู ุงููุญูุท", value=50000)
        growth = col2.slider("ูุนุฏู ุงูููู ุงูุณููู (%)", 0.0, 5.0, 2.5) / 100
        future_pop = pop * ((1 + growth) ** 10)
        col2.info(f"๐ ุงูุณูุงู ุงููุชููุน (10 ุณููุงุช): {int(future_pop):,} ูุณูุฉ")
        

    # --- ุงูุชุจููุจ 2: ุงูุชูููู ุงููุงูู (ุงููุชุจูู ูุงูุฏุฎู) ---
    with tabs[1]:
        c1, c2 = st.columns(2)
        gdv = c1.number_input("ุงููููุฉ ุงูุชุทููุฑูุฉ ุงููุชููุนุฉ (GDV)", value=20000000)
        capex = c1.number_input("ุชูุงููู ุงูุชุดููุฏ (CAPEX)", value=12000000)
        term = c1.slider("ูุฏุฉ ุงูุนูุฏ", 5, ACTIVITIES_DB[selected_act]["max_term"], 25)
        
        # ูุญุฑู ุงููููุฉ ุงููุชุจููุฉ
        residual = max(gdv - (capex * 1.12 + gdv * 0.18), 0)
        base_rent = residual * 0.08 if ACTIVITIES_DB[selected_act]["method"] == "ุงููุชุจูู" else (gdv * 0.05)
        
        c2.metric("ุงูุฃุฌุฑุฉ ุงูุณูููุฉ ุงูุนุงุฏูุฉ (ุงูุณูุฉ ุงูุฃููู)", f"{base_rent:,.0f} ุฑูุงู")
        # ุฌุฏูู ุงูููู ุงูุฎูุงุณู (ุงููุงุฏุฉ 26)
        schedule = [base_rent * (1.05 ** (i // 5)) for i in range(term)]
        c2.area_chart(schedule)
        

    # --- ุงูุชุจููุจ 3: ููุญุฉ ุงูุชุญูู (ุชุญููู ุงูู 1800 ุนูุฏ) ---
    with tabs[2]:
        st.subheader("๐ ุชุญููู ูุฌูุฉ ุงูุฅูุฑุงุฏุงุช ูู ุงููุญูุธุฉ")
        # ูุญุงูุงุฉ ูุจูุงูุงุช ููู ุงูู 1800 ุนูุฏ ุงูุฎุงุต ุจู
        kpi_df = pd.DataFrame({
            'ุงููุดุงุท': list(ACTIVITIES_DB.keys())[:5],
            'ุงูุฅูุฑุงุฏ ุงูุญุงูู': [120, 85, 40, 60, 95],
            'ุงูุฅูุฑุงุฏ ุงูุนุงุฏู': [155, 115, 55, 75, 130]
        })
        fig = px.bar(kpi_df, x='ุงููุดุงุท', y=['ุงูุฅูุฑุงุฏ ุงูุญุงูู', 'ุงูุฅูุฑุงุฏ ุงูุนุงุฏู'], barmode='group',
                     title="ุงูุฃุฑุจุงุญ ุงููุณุชุฑุฏุฉ ุจุงูููููู (ุงููุฌูุฉ ุงููุงููุฉ)", color_discrete_sequence=['#1e3d59', '#d35400'])
        st.plotly_chart(fig, use_container_width=True)
        

    # --- ุงูุชุจููุจ 4: ุงููุฎุฑุฌุงุช ูุงูุฎุทุงุจุงุช ู QR ---
    with tabs[3]:
        st.subheader("๐ ุฅุตุฏุงุฑ ุงููุซุงุฆู ุงูุฑุณููุฉ")
        contract_id = st.text_input("ุฑูู ุงูุนูุฏ ุงููุณุชูุฏู (ูู ููู ุงูุนููุฏ)", "30040868948")
        
        letter = f"""
        ุณุนุงุฏุฉ ูุณุชุซูุฑ ูุดุงุท ({selected_act}) ุงููุญุชุฑูุ
        ุจูุงุกู ุนูู ุงูุชูููู ุงูููู ูููููุน ุฑูู ({contract_id}) ูุงุณุชูุงุฏุงู ูุฏููู ุงูุชูููู 2023ุ 
        ูุญูุทูู ุนููุงู ุจุฃู ุงูุฃุฌุฑุฉ ุงูุนุงุฏูุฉ ุงููุนุชูุฏุฉ ูู {base_rent:,.0f} ุฑูุงู ุณูููุงู.
        """
        st.text_area("ูุณูุฏุฉ ุงูุฅุดุนุงุฑ", letter, height=150)
        
        # QR Code ุงูููุซู
        qr_data = f"ID:{contract_id}|Rent:{base_rent:.0f}|Score:{score}"
        qr = qrcode.make(qr_data)
        buf = BytesIO()
        qr.save(buf, format="PNG")
        st.image(buf.getvalue(), caption="ุฑูุฒ ููุซูููุฉ ุงูุชูููู ุงูุงุณุชุฑุงุชูุฌู")

st.markdown("---")
st.caption("ููุตุฉ ุฅุณุชุฏุงูุฉ | ุงููุณุฎุฉ ุงููุชูุงููุฉ 2026")
